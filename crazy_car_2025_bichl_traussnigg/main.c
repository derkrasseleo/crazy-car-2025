#include <msp430.h>
#include "hal_general.h"
#include "hal_gpio.h"
#include "DL/driver_aktorik.h"
#include "hal_usciB1.h"
#include "DL/driver_general.h"
#include "DL/driver_lcd.h"
#include "HAL/hal_adc12.h"
#include "algorithm/algo.h"
#include "HAL/hal_timerA0.h"
#include "algorithm/algo.h"

void Display_Init(void);

extern ButtonCom button;
extern ADC12Com adc;

extern unsigned char ticks;
extern int speed;
extern int state;

unsigned char direction = 0;
int cnt = 0;
signed char perc_speed = 0;
unsigned char perc_steer = 0;
int ir_front_val = 0;
int ir_left_val = 0;
int ir_right_val = 0;
int vbat = 0;

unsigned char driving_status = 0;

unsigned short ir_front[512] = {1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1500,1496,1463,1432,1403,1375,1348,1323,1299,1276,1254,1233,1213,1193,1175,1157,1141,1124,1109,1094,1079,1065,1052,1039,1026,1014,1002,991,980,969,958,948,938,928,918,909,900,891,882,873,864,856,848,839,831,823,816,808,800,793,785,778,771,764,757,750,743,736,729,723,716,710,703,697,690,684,678,672,666,660,654,649,643,637,632,626,621,615,610,605,600,595,590,585,580,575,570,565,561,556,552,547,543,538,534,530,526,522,518,514,510,506,502,498,494,491,487,483,480,476,473,470,466,463,460,456,453,450,447,444,441,438,435,432,429,426,423,420,418,415,412,410,407,404,402,399,396,394,391,389,387,384,382,379,377,375,372,370,368,365,363,361,359,356,354,352,350,348,346,344,342,340,337,335,333,331,329,327,326,324,322,320,318,316,314,312,310,309,307,305,303,301,300,298,296,294,293,291,289,288,286,284,283,281,279,278,276,275,273,271,270,268,267,265,264,262,261,259,258,256,255,253,252,251,249,248,246,245,244,242,241,240,238,237,236,234,233,232,230,229,228,227,225,224,223,222,220,219,218,217,216,214,213,212,211,210,208,207,206,205,204,203,201,200,199,198,197,196,195,193,192,191,190,189,188,187,186,185,184,182,181,180,179,178,177,176,175,174,173,172,171,170,168,167,166,165,164,163,162,161,160,159,158,157,156,155,154,153,152,151,150,149,148,146,145,144,143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128,127,126,125,124,123,122,121,120,119,118,117,116,115,114,113,112,111,110,109,108,107,106,105,104,103,102,101,100,99,98,97,96,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,46,45,44,43,42,41,40,39,38,37,36,35,33,32,31,30,29,27,26,25,24,23,21,20,19,18,16,15,14,12,11,10,9,7,6,5,4,3,2,1,0};
unsigned short ir_left[512] = {660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,653,645,637,630,622,615,607,600,593,586,579,572,566,559,553,546,540,534,528,522,516,510,504,498,493,487,482,476,471,466,461,455,450,446,441,436,431,427,422,417,413,409,404,400,396,392,388,384,380,376,372,368,364,361,357,354,350,347,343,340,337,333,330,327,324,321,318,315,312,309,306,303,300,298,295,292,289,287,284,282,279,277,274,272,270,267,265,263,261,258,256,254,252,250,248,246,244,242,240,238,236,234,232,231,229,227,225,223,222,220,218,217,215,214,212,210,209,207,206,204,203,201,200,199,197,196,194,193,192,190,189,188,187,185,184,183,182,180,179,178,177,176,175,173,172,171,170,169,168,167,166,165,164,163,162,161,160,159,158,157,156,155,154,153,152,151,150,149,149,148,147,146,145,144,143,143,142,141,140,139,139,138,137,136,136,135,134,133,133,132,131,130,130,129,128,127,127,126,125,125,124,123,123,122,121,121,120,119,119,118,118,117,116,116,115,115,114,113,113,112,112,111,110,110,109,109,108,108,107,107,106,105,105,104,104,103,103,102,102,101,101,100,100,99,99,98,98,97,97,96,96,95,95,94,94,93,93,93,92,92,91,91,90,90,89,89,89,88,88,87,87,86,86,86,85,85,84,84,84,83,83,82,82,81,81,81,80,80,80,79,79,78,78,78,77,77,77,76,76,75,75,75,74,74,74,73,73,72,72,72,71,71,71,70,70,70,69,69,69,68,68,68,67,67,67,66,66,66,65,65,65,64,64,64,63,63,63,62,62,62,61,61,61,60,60,60,59,59,59,58,58,58,57,57,57,56,56,56,56,55,55,55,54,54,54,53,53,53,52,52,52,52,51,51,51,50,50,50,50,49,49,49,48,48,48,48,47,47,47,46,46,46,46,45,45,45,45,44,44,44,44,43,43,43,43,43,42,42,42,42,42,41,41,41,41,41,40,40,40,40,40,40,40,39};
unsigned short ir_right[512] = {660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,660,658,651,645,638,631,624,618,611,605,599,592,586,580,574,568,562,556,550,544,539,533,528,522,517,511,506,501,495,490,485,480,475,470,465,461,456,451,447,442,437,433,429,424,420,416,411,407,403,399,395,391,387,383,379,376,372,368,364,361,357,354,350,347,343,340,337,333,330,327,324,321,318,315,312,309,306,303,300,297,294,292,289,286,283,281,278,276,273,271,268,266,263,261,259,256,254,252,250,248,245,243,241,239,237,235,233,231,229,227,225,223,222,220,218,216,214,213,211,209,208,206,204,203,201,200,198,197,195,194,192,191,189,188,186,185,184,182,181,180,178,177,176,175,174,172,171,170,169,168,167,165,164,163,162,161,160,159,158,157,156,155,154,153,152,151,150,149,148,148,147,146,145,144,143,142,142,141,140,139,138,138,137,136,135,135,134,133,132,132,131,130,130,129,128,128,127,126,126,125,124,124,123,122,122,121,121,120,119,119,118,118,117,116,116,115,115,114,114,113,113,112,111,111,110,110,109,109,108,108,107,107,106,106,105,105,104,104,103,103,102,102,101,101,101,100,100,99,99,98,98,97,97,96,96,96,95,95,94,94,93,93,92,92,92,91,91,90,90,89,89,89,88,88,87,87,86,86,86,85,85,84,84,84,83,83,82,82,82,81,81,80,80,79,79,79,78,78,77,77,77,76,76,76,75,75,74,74,74,73,73,72,72,72,71,71,70,70,70,69,69,69,68,68,67,67,67,66,66,66,65,65,65,64,64,63,63,63,62,62,62,61,61,61,60,60,60,59,59,59,58,58,58,57,57,57,56,56,56,55,55,55,54,54,54,53,53,53,53,52,52,52,51,51,51,51,50,50,50,49,49,49,49,48,48,48,48,47,47,47,47,46,46,46,46,46,45,45,45,45,45,44,44,44,44,44,43,43,43,43,43,43,42,42,42,42,42,42,42,41,41,41,41,41,41,41,41,41,40,40,40,40,40,40,40,40,40};

int main(void)
{
 	HAL_Init();
    Driver_Init();

    Display_Init();

    while (1) {
        cnt++;

        if (adc.Status.B.ADCrdy == 1)
        {
            adc.Status.B.ADCrdy = 0;
            ir_front_val = ir_front[adc.ADCBuffer[2]>>3];
            ir_left_val = ir_left[adc.ADCBuffer[1]>>3];
            ir_right_val = ir_right[adc.ADCBuffer[0]>>3];
            vbat = adc.ADCBuffer[3];

            if(cnt >= 10000) // use cnt to slow down display
            {
                cnt = 0;
                Driver_LCD_WriteNumber(ir_front_val, 5, 1, 6*6);
                Driver_LCD_WriteNumber(ir_left_val,  5, 2, 6*6);
                Driver_LCD_WriteNumber(ir_right_val, 5, 3, 6*6);
                Driver_LCD_WriteNumber(vbat,         5, 4, 6*6);
                Driver_LCD_WriteNumber(speed,        5, 5, 6*6);
                Driver_LCD_WriteNumber(perc_speed,   5, 6, 6*6);
                Driver_LCD_WriteNumber(state,        5, 7, 6*6);
            }

            if(driving_status == 1)
            {
                primitive_driving(&perc_steer, &perc_speed, ir_front_val, ir_left_val, ir_right_val);
                Driver_SetSteering(perc_steer);
                Driver_SetThrottle(perc_speed);
            }
            else if(driving_status == 0)
            {
                Driver_SteeringInit();
                Driver_SetThrottle(0);
            }
        }

        if (button.active) {
            switch (button.button) {
                case 1:
                    LCD_BACKLIGHT_ON;
                    Display_Init();
                    driving_status = 1;
                    break;

                case 2:
                    LCD_BACKLIGHT_OFF;
                    Driver_LCD_Clear();
                    driving_status = 0;
                    break;

                default:
                    break;
            }
        }
        button.active = 0; // Reset button state
    }
	return 0;
}

void Display_Init(void)
{
    Driver_LCD_WriteText("FRONT:", 6, 1, 0);
    Driver_LCD_WriteText("LEFT :", 6, 2, 0);
    Driver_LCD_WriteText("RIGHT:", 6, 3, 0);
    Driver_LCD_WriteText("VBAT :", 6, 4, 0);
    Driver_LCD_WriteText("SPEED:", 6, 5, 0);
    Driver_LCD_WriteText("PERCT:", 6, 6, 0);
    Driver_LCD_WriteText("STATE:", 6, 7, 0);
}

#pragma vector = PORT1_VECTOR

__interrupt void P1_ISR (void) {
    switch P1IFG {
        case STOP_BUTTON:
            button.active = 1;
            button.button = 1;
            P1IFG &= ~STOP_BUTTON;
        break;
        case START_BUTTON:
            button.active = 1;
            button.button = 2;
            P1IFG &= ~START_BUTTON;
        break;
        case RPM_SENSOR:
            ticks++;
            P1IFG &= ~RPM_SENSOR;
        break;
        case RPM_SENSOR_DIR:
            // TODO: make speed value negative?
            direction = 1-direction;
            P1IFG &= ~RPM_SENSOR_DIR;
//            LCD_BACKLIGHT_TOGGLE;
        break;

        default:
            button.active = 0;
            button.button = 0;
            P1IFG = 0x00;
    }
}
